---
import LegacyLayout from "../../../layouts/LegacyLayout.astro";
import LegacyHeader from "../../../components/LegacyHeader.astro";
import LegacyFooter from "../../../components/LegacyFooter.astro";
import { verifySessionToken } from "../../../lib/adminAuth";
import { getSupabaseAdminClient } from "../../../lib/supabase";

export const prerender = false;

const status = Astro.url.searchParams.get("status");
const token = Astro.cookies.get("admin_session")?.value;
const isAuthed = verifySessionToken(token);

if (!isAuthed) {
  return Astro.redirect("/admin?status=auth");
}

// Fetch data from Supabase
const supabase = getSupabaseAdminClient();

const { data: approvedData } = await supabase
  .from('guestbook_entries')
  .select('*')
  .eq('status', 'approved')
  .order('created_at', { ascending: false });

const { data: pendingData } = await supabase
  .from('guestbook_entries')
  .select('*')
  .eq('status', 'pending')
  .order('created_at', { ascending: false });

const { data: configData } = await supabase
  .from('guestbook_config')
  .select('*')
  .eq('id', 1)
  .single();

const approved = approvedData || [];
const pending = pendingData || [];
const config = configData || {
  max_links: 2,
  max_comment_length: 800,
  max_field_length: 120,
  banned_terms: [],
  require_moderation: false,
};
---
<LegacyLayout
  title="Guestbook Admin @ mp.ls"
  description="Moderation tools for the mp.ls guestbook entries."
  robots="noindex, nofollow"
>
<div class="mpls-legacy">
<LegacyHeader />
<div class="guestbook-admin-header">
  <p><span class="legacy-font legacy-font--size-4 legacy-font--face-verdana"><b>Guestbook Admin</b></span></p>
  <p><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana"><a href="/admin">Admin Menu</a> | <a href="/guestbook/">View Guestbook</a></span></p>
</div>

<div class="guestbook-admin-status">
<table class="legacy-border-0 legacy-cellpadding-6 legacy-cellspacing-0 legacy-width-600">
  <tr>
    <td>
      {status === "auth" && (
        <p><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana"><b>Auth failed.</b> Check admin password.</span></p>
      )}
      {status === "ok" && (
        <p><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana"><b>Saved.</b></span></p>
      )}
      {status === "error" && (
        <p><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana"><b>Error.</b> Try again.</span></p>
      )}
    </td>
  </tr>
</table>
</div>

<div class="guestbook-admin-config">
<table class="legacy-border-1 legacy-cellpadding-6 legacy-cellspacing-0 legacy-width-600">
  <tr>
    <td>
      <form action="/api/guestbook/admin" method="post">
        <input type="hidden" name="action" value="update-config">
        <table class="legacy-border-0 legacy-cellpadding-4 legacy-cellspacing-0 legacy-width-100pct">
          <tr>
            <td><label for="gb-config-max-links"><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">Max Links</span></label></td>
            <td><input type="number" id="gb-config-max-links" name="maxLinks" value={config.max_links} min="0" max="10"></td>
          </tr>
          <tr>
            <td><label for="gb-config-max-comment-length"><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">Max Comment Length</span></label></td>
            <td><input type="number" id="gb-config-max-comment-length" name="maxCommentLength" value={config.max_comment_length} min="50" max="2000"></td>
          </tr>
          <tr>
            <td><label for="gb-config-max-field-length"><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">Max Field Length</span></label></td>
            <td><input type="number" id="gb-config-max-field-length" name="maxFieldLength" value={config.max_field_length} min="20" max="300"></td>
          </tr>
          <tr>
            <td><label for="gb-config-require-moderation"><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">Require Moderation</span></label></td>
            <td><input type="checkbox" id="gb-config-require-moderation" name="requireModeration" checked={config.require_moderation}></td>
          </tr>
          <tr>
            <td class="legacy-valign-top"><label for="gb-config-banned-terms"><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">Banned Terms</span></label></td>
            <td>
              <textarea id="gb-config-banned-terms" name="bannedTerms" rows="5" cols="40">{config.banned_terms.join("\n")}</textarea>
            </td>
          </tr>
          <tr>
            <td></td>
            <td><input type="submit" value="Update Filter"></td>
          </tr>
        </table>
      </form>
    </td>
  </tr>
</table>
</div>

<div class="guestbook-admin-section-title">
  <p><span class="legacy-font legacy-font--size-3 legacy-font--face-verdana"><b>Pending Entries</b></span></p>
</div>
{pending.length === 0 && (
  <div class="guestbook-admin-no-entries"><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">No pending entries.</span></div>
)}
{pending.map((entry) => (
  <div class="guestbook-admin-entry-container">
  <table class="legacy-border-1 legacy-cellpadding-6 legacy-cellspacing-0 legacy-width-600">
    <tr>
      <td>
        <form action="/api/guestbook/admin" method="post">
          <input type="hidden" name="action" value="update">
          <input type="hidden" name="list" value="pending">
          <input type="hidden" name="record" value={entry.record}>
          <table class="legacy-border-0 legacy-cellpadding-4 legacy-cellspacing-0 legacy-width-100pct">
            <tr>
              <td class="guestbook-admin-record-cell"><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana"><b>Record {entry.record}</b></span></td>
              <td><span class="legacy-font legacy-font--size--2 legacy-font--face-verdana">Flagged: {entry.flagged ? "Yes" : "No"}</span></td>
            </tr>
            <tr>
              <td><label for={`pending-name-${entry.record}`}><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">Name</span></label></td>
              <td><input type="text" id={`pending-name-${entry.record}`} name="name" value={entry.name} size="40"></td>
            </tr>
            <tr>
              <td><label for={`pending-website-${entry.record}`}><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">Website</span></label></td>
              <td><input type="text" id={`pending-website-${entry.record}`} name="website" value={entry.website} size="40"></td>
            </tr>
            <tr>
              <td><label for={`pending-referred-by-${entry.record}`}><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">Referred By</span></label></td>
              <td><input type="text" id={`pending-referred-by-${entry.record}`} name="referredBy" value={entry.referred_by} size="40"></td>
            </tr>
            <tr>
              <td><label for={`pending-from-${entry.record}`}><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">From</span></label></td>
              <td><input type="text" id={`pending-from-${entry.record}`} name="from" value={entry.from_location} size="40"></td>
            </tr>
            <tr>
              <td class="legacy-valign-top"><label for={`pending-comments-${entry.record}`}><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">Comments</span></label></td>
              <td><textarea id={`pending-comments-${entry.record}`} name="comments" rows="4" cols="46">{entry.comments}</textarea></td>
            </tr>
            <tr>
              <td><label for={`pending-private-${entry.record}`}><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">Private</span></label></td>
              <td><input type="checkbox" id={`pending-private-${entry.record}`} name="privateMessage" checked={entry.private_message}></td>
            </tr>
            <tr>
              <td></td>
              <td>
                <input type="submit" value="Save">
              </td>
            </tr>
          </table>
        </form>
        <form action="/api/guestbook/admin" method="post">
          <input type="hidden" name="action" value="approve">
          <input type="hidden" name="record" value={entry.record}>
          <input type="submit" value="Approve">
        </form>
        <form action="/api/guestbook/admin" method="post">
          <input type="hidden" name="action" value="reject">
          <input type="hidden" name="record" value={entry.record}>
          <input type="submit" value="Reject">
        </form>
      </td>
    </tr>
  </table>
  </div>
))}

<div class="guestbook-admin-section-title">
  <p><span class="legacy-font legacy-font--size-3 legacy-font--face-verdana"><b>Approved Entries</b></span></p>
</div>
{approved.length === 0 && (
  <div class="guestbook-admin-no-entries"><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">No approved entries.</span></div>
)}
{approved.map((entry) => (
  <div class="guestbook-admin-entry-container">
  <table class="legacy-border-1 legacy-cellpadding-6 legacy-cellspacing-0 legacy-width-600">
    <tr>
      <td>
        <form action="/api/guestbook/admin" method="post">
          <input type="hidden" name="action" value="update">
          <input type="hidden" name="list" value="approved">
          <input type="hidden" name="record" value={entry.record}>
          <table class="legacy-border-0 legacy-cellpadding-4 legacy-cellspacing-0 legacy-width-100pct">
            <tr>
              <td class="guestbook-admin-record-cell"><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana"><b>Record {entry.record}</b></span></td>
              <td><span class="legacy-font legacy-font--size--2 legacy-font--face-verdana">{new Date(entry.created_at).toISOString().replace("T", " ").slice(0, 19)}</span></td>
            </tr>
            <tr>
              <td><label for={`approved-name-${entry.record}`}><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">Name</span></label></td>
              <td><input type="text" id={`approved-name-${entry.record}`} name="name" value={entry.name} size="40"></td>
            </tr>
            <tr>
              <td><label for={`approved-website-${entry.record}`}><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">Website</span></label></td>
              <td><input type="text" id={`approved-website-${entry.record}`} name="website" value={entry.website} size="40"></td>
            </tr>
            <tr>
              <td><label for={`approved-referred-by-${entry.record}`}><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">Referred By</span></label></td>
              <td><input type="text" id={`approved-referred-by-${entry.record}`} name="referredBy" value={entry.referred_by} size="40"></td>
            </tr>
            <tr>
              <td><label for={`approved-from-${entry.record}`}><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">From</span></label></td>
              <td><input type="text" id={`approved-from-${entry.record}`} name="from" value={entry.from_location} size="40"></td>
            </tr>
            <tr>
              <td class="legacy-valign-top"><label for={`approved-comments-${entry.record}`}><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">Comments</span></label></td>
              <td><textarea id={`approved-comments-${entry.record}`} name="comments" rows="4" cols="46">{entry.comments}</textarea></td>
            </tr>
            <tr>
              <td><label for={`approved-private-${entry.record}`}><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">Private</span></label></td>
              <td><input type="checkbox" id={`approved-private-${entry.record}`} name="privateMessage" checked={entry.private_message}></td>
            </tr>
            <tr>
              <td></td>
              <td>
                <input type="submit" value="Save">
              </td>
            </tr>
          </table>
        </form>
        <form action="/api/guestbook/admin" method="post">
          <input type="hidden" name="action" value="delete">
          <input type="hidden" name="record" value={entry.record}>
          <input type="submit" value="Delete">
        </form>
      </td>
    </tr>
  </table>
  </div>
))}
<LegacyFooter />
</div>
</LegacyLayout>



