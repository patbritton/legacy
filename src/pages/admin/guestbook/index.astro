---
import LegacyLayout from "../../../layouts/LegacyLayout.astro";
import LegacyHeader from "../../../components/LegacyHeader.astro";
import LegacyFooter from "../../../components/LegacyFooter.astro";
import { verifySessionToken } from "../../../lib/adminAuth";
import { getSupabaseAdminClient } from "../../../lib/supabase";

export const prerender = false;

const status = Astro.url.searchParams.get("status");
const token = Astro.cookies.get("admin_session")?.value;
const isAuthed = verifySessionToken(token);

if (!isAuthed) {
  return Astro.redirect("/admin?status=auth");
}

// Fetch data from Supabase
const supabase = getSupabaseAdminClient();

const { data: approvedData } = await supabase
  .from('guestbook_entries')
  .select('*')
  .eq('status', 'approved')
  .order('created_at', { ascending: false });

const { data: pendingData } = await supabase
  .from('guestbook_entries')
  .select('*')
  .eq('status', 'pending')
  .order('created_at', { ascending: false });

const { data: configData } = await supabase
  .from('guestbook_config')
  .select('*')
  .eq('id', 1)
  .single();

const approved = approvedData || [];
const pending = pendingData || [];
const config = configData || {
  max_links: 2,
  max_comment_length: 800,
  max_field_length: 120,
  banned_terms: [],
  require_moderation: false,
};
---
<LegacyLayout title="Guestbook Admin @ mpls.com">
<div class="mpls-legacy">
<LegacyHeader />
<div class="guestbook-admin-header">
  <p><font face="Verdana,Helvetica,Arial" size="4"><b>Guestbook Admin</b></font></p>
  <p><font face="Verdana,Helvetica,Arial" size="-1"><a href="/admin">Admin Menu</a> | <a href="/guestbook/">View Guestbook</a></font></p>
</div>

<div class="guestbook-admin-status">
<table border="0" cellpadding="6" cellspacing="0" width="600">
  <tr>
    <td>
      {status === "auth" && (
        <p><font face="Verdana,Helvetica,Arial" size="-1"><b>Auth failed.</b> Check admin password.</font></p>
      )}
      {status === "ok" && (
        <p><font face="Verdana,Helvetica,Arial" size="-1"><b>Saved.</b></font></p>
      )}
      {status === "error" && (
        <p><font face="Verdana,Helvetica,Arial" size="-1"><b>Error.</b> Try again.</font></p>
      )}
    </td>
  </tr>
</table>
</div>

<div class="guestbook-admin-config">
<table border="1" cellpadding="6" cellspacing="0" width="600">
  <tr>
    <td>
      <form action="/api/guestbook/admin" method="post">
        <input type="hidden" name="action" value="update-config">
        <table border="0" cellpadding="4" cellspacing="0" width="100%">
          <tr>
            <td><label for="gb-config-max-links"><font face="Verdana,Helvetica,Arial" size="-1">Max Links</font></label></td>
            <td><input type="number" id="gb-config-max-links" name="maxLinks" value={config.max_links} min="0" max="10"></td>
          </tr>
          <tr>
            <td><label for="gb-config-max-comment-length"><font face="Verdana,Helvetica,Arial" size="-1">Max Comment Length</font></label></td>
            <td><input type="number" id="gb-config-max-comment-length" name="maxCommentLength" value={config.max_comment_length} min="50" max="2000"></td>
          </tr>
          <tr>
            <td><label for="gb-config-max-field-length"><font face="Verdana,Helvetica,Arial" size="-1">Max Field Length</font></label></td>
            <td><input type="number" id="gb-config-max-field-length" name="maxFieldLength" value={config.max_field_length} min="20" max="300"></td>
          </tr>
          <tr>
            <td><label for="gb-config-require-moderation"><font face="Verdana,Helvetica,Arial" size="-1">Require Moderation</font></label></td>
            <td><input type="checkbox" id="gb-config-require-moderation" name="requireModeration" checked={config.require_moderation}></td>
          </tr>
          <tr>
            <td valign="top"><label for="gb-config-banned-terms"><font face="Verdana,Helvetica,Arial" size="-1">Banned Terms</font></label></td>
            <td>
              <textarea id="gb-config-banned-terms" name="bannedTerms" rows="5" cols="40">{config.banned_terms.join("\n")}</textarea>
            </td>
          </tr>
          <tr>
            <td></td>
            <td><input type="submit" value="Update Filter"></td>
          </tr>
        </table>
      </form>
    </td>
  </tr>
</table>
</div>

<div class="guestbook-admin-section-title">
  <p><font face="Verdana,Helvetica,Arial" size="3"><b>Pending Entries</b></font></p>
</div>
{pending.length === 0 && (
  <div class="guestbook-admin-no-entries"><font face="Verdana,Helvetica,Arial" size="-1">No pending entries.</font></div>
)}
{pending.map((entry) => (
  <div class="guestbook-admin-entry-container">
  <table border="1" cellpadding="6" cellspacing="0" width="600">
    <tr>
      <td>
        <form action="/api/guestbook/admin" method="post">
          <input type="hidden" name="action" value="update">
          <input type="hidden" name="list" value="pending">
          <input type="hidden" name="record" value={entry.record}>
          <table border="0" cellpadding="4" cellspacing="0" width="100%">
            <tr>
              <td style="width: 160px"><font face="Verdana,Helvetica,Arial" size="-1"><b>Record {entry.record}</b></font></td>
              <td><font face="Verdana,Helvetica,Arial" size="-2">Flagged: {entry.flagged ? "Yes" : "No"}</font></td>
            </tr>
            <tr>
              <td><label for={`pending-name-${entry.record}`}><font face="Verdana,Helvetica,Arial" size="-1">Name</font></label></td>
              <td><input type="text" id={`pending-name-${entry.record}`} name="name" value={entry.name} size="40"></td>
            </tr>
            <tr>
              <td><label for={`pending-website-${entry.record}`}><font face="Verdana,Helvetica,Arial" size="-1">Website</font></label></td>
              <td><input type="text" id={`pending-website-${entry.record}`} name="website" value={entry.website} size="40"></td>
            </tr>
            <tr>
              <td><label for={`pending-referred-by-${entry.record}`}><font face="Verdana,Helvetica,Arial" size="-1">Referred By</font></label></td>
              <td><input type="text" id={`pending-referred-by-${entry.record}`} name="referredBy" value={entry.referred_by} size="40"></td>
            </tr>
            <tr>
              <td><label for={`pending-from-${entry.record}`}><font face="Verdana,Helvetica,Arial" size="-1">From</font></label></td>
              <td><input type="text" id={`pending-from-${entry.record}`} name="from" value={entry.from_location} size="40"></td>
            </tr>
            <tr>
              <td valign="top"><label for={`pending-comments-${entry.record}`}><font face="Verdana,Helvetica,Arial" size="-1">Comments</font></label></td>
              <td><textarea id={`pending-comments-${entry.record}`} name="comments" rows="4" cols="46">{entry.comments}</textarea></td>
            </tr>
            <tr>
              <td><label for={`pending-private-${entry.record}`}><font face="Verdana,Helvetica,Arial" size="-1">Private</font></label></td>
              <td><input type="checkbox" id={`pending-private-${entry.record}`} name="privateMessage" checked={entry.private_message}></td>
            </tr>
            <tr>
              <td></td>
              <td>
                <input type="submit" value="Save">
              </td>
            </tr>
          </table>
        </form>
        <form action="/api/guestbook/admin" method="post">
          <input type="hidden" name="action" value="approve">
          <input type="hidden" name="record" value={entry.record}>
          <input type="submit" value="Approve">
        </form>
        <form action="/api/guestbook/admin" method="post">
          <input type="hidden" name="action" value="reject">
          <input type="hidden" name="record" value={entry.record}>
          <input type="submit" value="Reject">
        </form>
      </td>
    </tr>
  </table>
  </div>
))}

<div class="guestbook-admin-section-title">
  <p><font face="Verdana,Helvetica,Arial" size="3"><b>Approved Entries</b></font></p>
</div>
{approved.length === 0 && (
  <div class="guestbook-admin-no-entries"><font face="Verdana,Helvetica,Arial" size="-1">No approved entries.</font></div>
)}
{approved.map((entry) => (
  <div class="guestbook-admin-entry-container">
  <table border="1" cellpadding="6" cellspacing="0" width="600">
    <tr>
      <td>
        <form action="/api/guestbook/admin" method="post">
          <input type="hidden" name="action" value="update">
          <input type="hidden" name="list" value="approved">
          <input type="hidden" name="record" value={entry.record}>
          <table border="0" cellpadding="4" cellspacing="0" width="100%">
            <tr>
              <td style="width: 160px"><font face="Verdana,Helvetica,Arial" size="-1"><b>Record {entry.record}</b></font></td>
              <td><font face="Verdana,Helvetica,Arial" size="-2">{new Date(entry.created_at).toISOString().replace("T", " ").slice(0, 19)}</font></td>
            </tr>
            <tr>
              <td><label for={`approved-name-${entry.record}`}><font face="Verdana,Helvetica,Arial" size="-1">Name</font></label></td>
              <td><input type="text" id={`approved-name-${entry.record}`} name="name" value={entry.name} size="40"></td>
            </tr>
            <tr>
              <td><label for={`approved-website-${entry.record}`}><font face="Verdana,Helvetica,Arial" size="-1">Website</font></label></td>
              <td><input type="text" id={`approved-website-${entry.record}`} name="website" value={entry.website} size="40"></td>
            </tr>
            <tr>
              <td><label for={`approved-referred-by-${entry.record}`}><font face="Verdana,Helvetica,Arial" size="-1">Referred By</font></label></td>
              <td><input type="text" id={`approved-referred-by-${entry.record}`} name="referredBy" value={entry.referred_by} size="40"></td>
            </tr>
            <tr>
              <td><label for={`approved-from-${entry.record}`}><font face="Verdana,Helvetica,Arial" size="-1">From</font></label></td>
              <td><input type="text" id={`approved-from-${entry.record}`} name="from" value={entry.from_location} size="40"></td>
            </tr>
            <tr>
              <td valign="top"><label for={`approved-comments-${entry.record}`}><font face="Verdana,Helvetica,Arial" size="-1">Comments</font></label></td>
              <td><textarea id={`approved-comments-${entry.record}`} name="comments" rows="4" cols="46">{entry.comments}</textarea></td>
            </tr>
            <tr>
              <td><label for={`approved-private-${entry.record}`}><font face="Verdana,Helvetica,Arial" size="-1">Private</font></label></td>
              <td><input type="checkbox" id={`approved-private-${entry.record}`} name="privateMessage" checked={entry.private_message}></td>
            </tr>
            <tr>
              <td></td>
              <td>
                <input type="submit" value="Save">
              </td>
            </tr>
          </table>
        </form>
        <form action="/api/guestbook/admin" method="post">
          <input type="hidden" name="action" value="delete">
          <input type="hidden" name="record" value={entry.record}>
          <input type="submit" value="Delete">
        </form>
      </td>
    </tr>
  </table>
  </div>
))}
<LegacyFooter />
</div>
</LegacyLayout>



