---
// @ts-nocheck
import LegacyLayout from "../layouts/LegacyLayout.astro";
import LegacyHeader from "../components/LegacyHeader.astro";
import LegacyFooter from "../components/LegacyFooter.astro";

export const prerender = false;
---
<LegacyLayout
  title="Minnesota Weather @ mp.ls"
  description="Legacy Minneapolis weather coverage with satellite imagery and local forecasts."
>
<div class="mpls-legacy">
<LegacyHeader showNav />


<br>
<div class="weather-page-title"><span class="legacy-font legacy-font--size-6 legacy-font--face-verdana"><b>MINNESOTA WEATHER</b></span></div>
<hr class="legacy-width-40pct">
<br>
<div class="weather-main-content">
<table class="legacy-border-0 legacy-cellpadding-0 legacy-cellspacing-0 legacy-width-600">
<tr>
<td class="legacy-width-600">
<div class="weather-widget-container">
<table class="weather-widget legacy-border-1 legacy-cellpadding-6 legacy-cellspacing-0 legacy-width-420">
  <tr>
    <td class="legacy-bgcolor-000000">
      <table class="wx-header legacy-border-0 legacy-cellpadding-0 legacy-cellspacing-0 legacy-width-100pct">
        <tr>
          <td class="legacy-valign-middle">
            <span class="legacy-font legacy-font--size-2 legacy-font--color-ffffff legacy-font--face-verdana"><b><span id="wx-header-city">MINNEAPOLIS</span> LIVE WEATHER</b></span>
          </td>
          <td class="legacy-align-right legacy-valign-middle">
            <a href="#" class="wx-edit-link" id="wx-edit-link">Change location</a>
          </td>
        </tr>
      </table>
    </td>
  </tr>
  <tr>
    <td>
      <div id="wx-edit" class="wx-edit">
        <form id="wx-form">
          <span class="legacy-font legacy-font--size-1 legacy-font--face-verdana"><b>Location:</b></span>
          <input id="wx-location" type="text" size="18" value="Minneapolis, MN" autocomplete="address-level2" list="wx-suggest">
          <input type="submit" value="Go">
          <span class="legacy-font legacy-font--size-1 legacy-font--face-verdana">Zip or City</span>
          <datalist id="wx-suggest">
            <option value="Minneapolis, MN"></option>
            <option value="St. Paul, MN"></option>
            <option value="Chicago, IL"></option>
            <option value="New York, NY"></option>
            <option value="Los Angeles, CA"></option>
            <option value="Dallas, TX"></option>
          </datalist>
        </form>
      </div>
      <table class="legacy-border-0 legacy-cellpadding-4 legacy-cellspacing-0 legacy-width-100pct">
        <tr>
          <td class="legacy-width-50pct"><span class="legacy-font legacy-font--size-2 legacy-font--face-verdana"><b>Temperature:</b></span></td>
          <td><span class="legacy-font legacy-font--size-2 legacy-font--face-verdana"><span id="wx-temp">Loading...</span></span></td>
        </tr>
        <tr>
          <td><span class="legacy-font legacy-font--size-2 legacy-font--face-verdana"><b>Conditions:</b></span></td>
          <td>
            <span class="legacy-font legacy-font--size-2 legacy-font--face-verdana">
              <span class="wx-icon" id="wx-icon">--</span>
              <span id="wx-cond">Loading...</span>
            </span>
          </td>
        </tr>
        <tr>
          <td><span class="legacy-font legacy-font--size-2 legacy-font--face-verdana"><b>Wind:</b></span></td>
          <td><span class="legacy-font legacy-font--size-2 legacy-font--face-verdana"><span id="wx-wind">Loading...</span></span></td>
        </tr>
        <tr>
          <td><span class="legacy-font legacy-font--size-2 legacy-font--face-verdana"><b>Updated:</b></span></td>
          <td>
            <span class="legacy-font legacy-font--size-2 legacy-font--face-verdana">
              <span id="wx-time">--</span><br>
              <span id="wx-place" class="wx-place">Minneapolis, MN</span>
            </span>
          </td>
        </tr>
      </table>
      <noscript>
        <p><span class="legacy-font legacy-font--size-1 legacy-font--face-verdana">Enable JavaScript to load live conditions.</span></p>
      </noscript>
    </td>
  </tr>
</table>
<br>
<a href="https://web.archive.org/web/19981203054014/http://208.217.109.20/weather/index/sites/national?site=&amp;city=Minneapolis%2FSt.+Paul+MN"><span class="legacy-font legacy-font--size-2 legacy-font--color-0000ff legacy-font--face-verdana">Current conditions and five-day forecast for Minneapolis &amp; St. Paul</span></a><br><br>
<a href="https://web.archive.org/web/19981203054014/http://www.intellicast.com/weather/msp/radar/"><span class="legacy-font legacy-font--size-2 legacy-font--color-0000ff legacy-font--face-verdana">Midwest Radar Image from Intellicast</span></a><br><br>
<a href="https://web.archive.org/web/19981203054014/http://www.met.tamu.edu/personnel/students/mkay/warnings_mn.html"><span class="legacy-font legacy-font--size-2 legacy-font--color-0000ff legacy-font--face-verdana">Current severe weather watches &amp; warnings for Minneapolis and the region.</span></a><br><br>
<a href="https://web.archive.org/web/19981203054014/http://www.crh.noaa.gov/mpx/climate.html"><span class="legacy-font legacy-font--size-2 legacy-font--color-0000ff legacy-font--face-verdana">Current and historical climate records and summaries for Minneapolis and the region.</span></a><br><br>
<a href="https://web.archive.org/web/19981203054014/http://www.crh.noaa.gov/mpx/mpxnew.html"><span class="legacy-font legacy-font--size-2 legacy-font--color-0000ff legacy-font--face-verdana">Homepage for National Weather Service office serving the Twin Cities</span></a><br><br>
</div>
</td>
</tr>
</table>
</div>
<br>
<div class="weather-images">
<p><span class="legacy-font legacy-font--size-3 legacy-font--face-verdana"><b>INFRARED SATELLITE IMAGE</b></span><br>
<img src="/img/ir.gif"><br></p>
<p><span class="legacy-font legacy-font--size-3 legacy-font--face-verdana"><b>VISIBLE SATELLITE IMAGE</b></span><br>
<img src="/img/vis.gif"><br></p>
<p><span class="legacy-font legacy-font--size-3 legacy-font--face-verdana"><b>ACCUWEATHER'S NEXRAD NATIONAL RADAR</b></span><br>
<img src="/img/usrad.gif"><br></p>
<p><span class="legacy-font legacy-font--size-3 legacy-font--face-verdana"><b>ACCUWEATHER'S NATIONAL SATELLITE VIEW</b></span><br>
<img src="/img/ussat.gif"><br></p>
<p><span class="legacy-font legacy-font--size-3 legacy-font--face-verdana"><b>24 HOUR FORECAST</b></span><br></p>
<div class="forecast-widget">
  <div class="forecast-banner">
    <div class="forecast-brand">
      <div class="forecast-brand-name">24/HR FORECAST</div>
    </div>
    <div class="forecast-badge">24</div>
  </div>
  <div class="weekly-forecast" id="hourly-forecast">
    <div class="forecast-loading">Loading forecast...</div>
  </div>
</div>
</div>
<div class="weather-footer"><hr class="legacy-width-600"></div>
<div class="weather-legacy-footer">
<LegacyFooter />
</div>
</LegacyLayout>

<script>
  const weatherCodeMap = {
    0: "Clear",
    1: "Mostly Clear",
    2: "Partly Cloudy",
    3: "Overcast",
    45: "Fog",
    48: "Rime Fog",
    51: "Light Drizzle",
    53: "Drizzle",
    55: "Heavy Drizzle",
    61: "Light Rain",
    63: "Rain",
    65: "Heavy Rain",
    71: "Light Snow",
    73: "Snow",
    75: "Heavy Snow",
    80: "Rain Showers",
    81: "Showers",
    82: "Heavy Showers",
    95: "Thunderstorm",
    96: "Thunderstorm + Hail",
    99: "Heavy Thunderstorm",
  };

  const weatherIconMap = {
    0: "SUN\nâ˜€",
    1: "SUN\nâ˜€",
    2: "PTLY\nâ›…",
    3: "CLOUDY\nâ˜",
    45: "FOG\nðŸŒ«",
    48: "FOG\nðŸŒ«",
    51: "DRIZ\nðŸŒ¦",
    53: "DRIZ\nðŸŒ¦",
    55: "RAIN\nðŸŒ§",
    61: "RAIN\nðŸŒ§",
    63: "RAIN\nðŸŒ§",
    65: "RAIN\nðŸŒ§",
    71: "SNOW\nðŸŒ¨",
    73: "SNOW\nðŸŒ¨",
    75: "SNOW\nâ„",
    80: "SHWR\nðŸŒ¦",
    81: "SHWR\nðŸŒ§",
    82: "SHWR\nðŸŒ§",
    95: "TST\nâš¡",
    96: "HAIL\nâ›ˆ",
    99: "TST\nâ›ˆ",
  };
  const weatherShortMap = {
    0: "CLEAR",
    1: "MOSTLY CLR",
    2: "PTLY CLOUDY",
    3: "CLOUDY",
    45: "FOG",
    48: "FOG",
    51: "DRIZZLE",
    53: "DRIZZLE",
    55: "DRIZZLE",
    61: "RAIN",
    63: "RAIN",
    65: "RAIN",
    71: "SNOW",
    73: "SNOW",
    75: "SNOW",
    80: "SHOWERS",
    81: "SHOWERS",
    82: "SHOWERS",
    95: "T-STORM",
    96: "T-STORM",
    99: "T-STORM",
  };


  const setText = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  };

  const setLocationLabel = (value) => {
    const label = value || "Minneapolis, MN";
    setText("wx-place", label);
    const city = label.split(",")[0] || "Minneapolis";
    setText("wx-header-city", city.toUpperCase());
  };

  const setIcon = (code) => {
    setText("wx-icon", weatherIconMap[code] || "--");
  };

  const fetchWeather = async (lat, lon) => {
    try {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,wind_speed_10m&temperature_unit=fahrenheit&wind_speed_unit=mph`;
      const response = await fetch(url, { cache: "no-store" });
      if (!response.ok) throw new Error("bad response");
      const data = await response.json();
      const current = data?.current;
      if (!current) throw new Error("no data");
      const temp = Math.round(current.temperature_2m);
      const wind = Math.round(current.wind_speed_10m);
      const cond = weatherCodeMap[current.weather_code] || "Conditions";
      const updated = current.time ? current.time.replace("T", " ") : "--";
      setText("wx-temp", `${temp}Â°F`);
      setText("wx-cond", cond);
      setIcon(current.weather_code);
      setText("wx-wind", `${wind} mph`);
      setText("wx-time", updated);
    } catch {
      setText("wx-temp", "Unavailable");
      setText("wx-cond", "Unavailable");
      setIcon(null);
      setText("wx-wind", "Unavailable");
      setText("wx-time", "--");
    }
  };

  const defaultLocation = {
    lat: 44.9778,
    lon: -93.2650,
    label: "Minneapolis, MN",
  };

  const fetchLocation = async (query) => {
    const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=1&language=en&format=json`;
    const response = await fetch(url, { cache: "no-store" });
    if (!response.ok) throw new Error("bad response");
    const data = await response.json();
    const result = data?.results?.[0];
    if (!result) throw new Error("no results");
    return {
      lat: result.latitude,
      lon: result.longitude,
      label: [result.name, result.admin1, result.country_code].filter(Boolean).join(", "),
    };
  };

  const loadWeatherFor = async (query) => {
    try {
      const location = await fetchLocation(query);
      setLocationLabel(location.label);
      localStorage.setItem("mpls-weather-location", query);
      await fetchWeather(location.lat, location.lon);
      await renderHourlyForecast(location.lat, location.lon);
    } catch {
      setLocationLabel(defaultLocation.label);
      setText("wx-cond", "Location not found");
      setIcon(null);
      await fetchWeather(defaultLocation.lat, defaultLocation.lon);
      await renderHourlyForecast(defaultLocation.lat, defaultLocation.lon);
    }
  };

  const form = document.getElementById("wx-form") as HTMLFormElement | null;
  const input = document.getElementById("wx-location") as HTMLInputElement | null;
  const editLink = document.getElementById("wx-edit-link") as HTMLAnchorElement | null;
  const editPanel = document.getElementById("wx-edit") as HTMLDivElement | null;
  const saved = localStorage.getItem("mpls-weather-location");
  if (saved && input) {
    input.value = saved;
  }

  if (editLink && editPanel) {
    editPanel.style.display = "none";
    editLink.addEventListener("click", (event) => {
      event.preventDefault();
      const isOpen = editPanel.style.display !== "none";
      editPanel.style.display = isOpen ? "none" : "block";
      editLink.textContent = isOpen ? "Change location" : "Close";
      if (!isOpen && input) {
        input.focus();
        input.select();
      }
    });
  }

  if (form && input) {
    form.addEventListener("submit", (event) => {
      event.preventDefault();
      const value = input.value.trim();
      if (value) {
        loadWeatherFor(value);
      }
    });
  }

  // Hourly forecast (3-hour intervals)
  const fetchHourlyForecast = async (lat, lon) => {
    try {
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=weather_code,temperature_2m&temperature_unit=fahrenheit&timezone=auto&forecast_days=2`;
      console.log('Fetching hourly forecast from:', url);
      const response = await fetch(url, { cache: "no-store" });
      console.log('Hourly forecast response status:', response.status, response.ok);
      if (!response.ok) throw new Error("bad response");
      const data = await response.json();
      console.log('Hourly forecast data:', data);
      console.log('Hourly forecast data.hourly:', data.hourly);
      return data.hourly;
    } catch (error) {
      console.error('Error fetching hourly forecast:', error);
      return null;
    }
  };

  const renderHourlyForecast = async (lat, lon) => {
    console.log('renderHourlyForecast called with lat:', lat, 'lon:', lon);
    const container = document.getElementById("hourly-forecast");
    console.log('Hourly forecast container found:', !!container);
    if (!container) return;

    try {
      /** @type {{ time: string[]; weather_code: number[]; temperature_2m: number[] } | null} */
      const hourly = await fetchHourlyForecast(lat, lon);
      console.log('Hourly data returned:', hourly);
      console.log('Hourly time array length:', hourly?.time?.length);

      if (!hourly?.time?.length) {
        console.error('No hourly forecast data received');
        container.innerHTML = '<div class="forecast-error">Forecast unavailable</div>';
        return;
      }

      const now = new Date();
      console.log('Current time:', now);
      const times = hourly.time.map((time) => new Date(time));
      console.log('First few times:', times.slice(0, 5));
      let startIndex = times.findIndex((time) => time >= now);
      console.log('Start index:', startIndex);
      if (startIndex == -1) startIndex = 0;

      const slots = [{ time: new Date(0), code: 0, temp: 0 }];
      slots.length = 0;
      const maxSlots = 5;
      for (let i = 0; i < maxSlots; i++) {
        const idx = startIndex + i * 3;
        if (idx >= times.length) break;
        slots.push({
          time: times[idx],
          code: hourly.weather_code[idx],
          temp: Math.round(hourly.temperature_2m[idx]),
        });
      }
      console.log('Slots created:', slots.length, slots);

      if (!slots.length) {
        console.error('No slots created!');
        container.innerHTML = '<div class="forecast-error">Forecast unavailable</div>';
        return;
      }

      let html = '<table class="forecast-table forecast-table-hourly legacy-border-1 legacy-cellspacing-0 legacy-cellpadding-0"><tr>';

      for (const slot of slots) {
        const hours = slot.time.getHours();
        const hourLabel = `${((hours + 11) % 12) + 1}${hours >= 12 ? "P" : "A"}`;
        const icon = weatherIconMap[slot.code] || "?";
        const condition = weatherCodeMap[slot.code] || "Cloudy";
        const conditionLabel = weatherShortMap[slot.code] || condition.toUpperCase();

        html += `
          <td class="forecast-slot">
            <div class="forecast-day-name">${hourLabel}</div>
            <div class="forecast-icon">${icon}</div>
            <div class="forecast-temps">
              <div class="forecast-temp-high">${slot.temp}F</div>
            </div>
          </td>
        `;
      }

      html += '</tr></table>';
      container.innerHTML = html;
    } catch (error) {
      console.error('Error rendering hourly forecast:', error);
      container.innerHTML = '<div class="forecast-error">Forecast unavailable</div>';
    }
  };

  loadWeatherFor(input?.value || "Minneapolis, MN");
</script>

















