---
import LegacyLayout from "../../layouts/LegacyLayout.astro";
import LegacyHeader from "../../components/LegacyHeader.astro";
import LegacyFooter from "../../components/LegacyFooter.astro";
import { getSupabaseClient } from "../../lib/supabase";

export const prerender = false;

const status = Astro.url.searchParams.get("status");
const siteKey = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY;

// Fetch approved entries from Supabase
const supabase = getSupabaseClient();
const { data: entries } = await supabase
  .from('guestbook_entries')
  .select('*')
  .eq('status', 'approved')
  .order('created_at', { ascending: false });

const sortedEntries = entries || [];
---
<LegacyLayout
  title="Guestbook @ mp.ls"
  description="Read and sign the mp.ls guestbook to share your Minneapolis memories."
>
<div class="mpls-legacy">
<LegacyHeader showNav />



<div class="guestbook-header">
  <span class="legacy-font legacy-font--size-4 legacy-font--face-verdana"><b>Guestbook</b></span>
</div>

<div class="guestbook-status-container">
<table class="legacy-border-0 legacy-cellpadding-6 legacy-cellspacing-0 legacy-width-600">
<tr>
<td>
  {status === "ok" && (
    <p><span class="legacy-font legacy-font--size--1 legacy-font--color-green legacy-font--face-verdana"><b>✓ Success!</b> Your entry has been posted and is now visible in the guestbook.</span></p>
  )}
  {status === "pending" && (
    <p><span class="legacy-font legacy-font--size--1 legacy-font--color-blue legacy-font--face-verdana"><b>✓ Submitted!</b> Your entry has been received and will appear after review. Thank you for signing our guestbook!</span></p>
  )}
  {status === "banned" && (
    <p><span class="legacy-font legacy-font--size--1 legacy-font--color-red legacy-font--face-verdana"><b>✗ Entry Rejected</b> Your submission contains prohibited content or language. Please review our guidelines and try again with appropriate content.</span></p>
  )}
  {status === "captcha" && (
    <p><span class="legacy-font legacy-font--size--1 legacy-font--color-orange legacy-font--face-verdana"><b>⚠ Verification Failed</b> Please complete the reCAPTCHA verification and try again.</span></p>
  )}
  {status === "error" && (
    <p><span class="legacy-font legacy-font--size--1 legacy-font--color-red legacy-font--face-verdana"><b>✗ Error</b> There was a problem submitting your entry. Please check that all required fields are filled and within the length limits.</span></p>
  )}
</td>
</tr>
</table>
</div>

<div class="guestbook-form-container">
<table class="legacy-border-1 legacy-cellpadding-6 legacy-cellspacing-0 legacy-width-600">
<tr>
<td>
<a id="sign"></a>
<form action="/api/guestbook/submit" method="post">
  <input type="text" name="company" value="" tabindex="-1" autocomplete="off" aria-hidden="true" class="guestbook-honeypot">
  <table class="guestbook-form-table legacy-border-0 legacy-cellpadding-4 legacy-cellspacing-0 legacy-width-100pct">
    <tr>
      <td class="guestbook-form-label"><label for="gb-name"><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">Name *</span></label></td>
      <td class="guestbook-form-field"><input type="text" id="gb-name" name="name" size="40" maxlength="120" required></td>
    </tr>
    <tr>
      <td class="guestbook-form-label"><label for="gb-website"><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">Website</span></label></td>
      <td class="guestbook-form-field"><input type="text" id="gb-website" name="website" size="40" maxlength="120"></td>
    </tr>
    <tr>
      <td class="guestbook-form-label"><label for="gb-referred-by"><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">Referred By</span></label></td>
      <td class="guestbook-form-field"><input type="text" id="gb-referred-by" name="referredBy" size="40" maxlength="120"></td>
    </tr>
    <tr>
      <td class="guestbook-form-label"><label for="gb-from"><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">From</span></label></td>
      <td class="guestbook-form-field"><input type="text" id="gb-from" name="from" size="40" maxlength="120"></td>
    </tr>
    <tr>
      <td class="guestbook-form-label legacy-valign-top"><label for="gb-comments"><span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">Comments *</span></label></td>
      <td class="guestbook-form-field"><textarea id="gb-comments" name="comments" rows="5" cols="46" maxlength="800" required></textarea></td>
    </tr>
    <tr>
      <td></td>
      <td class="guestbook-form-field">
        {siteKey ? (
          <div class="g-recaptcha" data-sitekey={siteKey} aria-label="reCAPTCHA"></div>
        ) : (
          <span class="legacy-font legacy-font--size--2 legacy-font--face-verdana">reCAPTCHA site key missing.</span>
        )}
      </td>
    </tr>
    <tr>
      <td></td>
      <td class="guestbook-form-field"><input type="submit" value="Sign Guestbook"></td>
    </tr>
  </table>
</form>
</td>
</tr>
</table>
</div>

<div class="guestbook-entries-header">
<table class="legacy-border-0 legacy-cellpadding-6 legacy-cellspacing-0 legacy-width-600">
  <tr>
    <td>
      <span class="legacy-font legacy-font--size--1 legacy-font--face-verdana"><b>Guestbook Entries</b></span>
    </td>
  </tr>
</table>
</div>

<div class="guestbook-entries-container">
<table class="legacy-border-1 legacy-cellpadding-6 legacy-cellspacing-0 legacy-width-600">
  {sortedEntries.map((entry) => {
    const websiteUrl = entry.website && entry.website.trim()
      ? (entry.website.startsWith('http://') || entry.website.startsWith('https://')
          ? entry.website
          : `http://${entry.website}`)
      : null;

    return (
      <tr>
        <td class="guestbook-entry-cell">
          <span class="legacy-font legacy-font--size--1 legacy-font--face-verdana"><b>Record {entry.record}</b></span><br>
          <span class="legacy-font legacy-font--size--1 legacy-font--face-verdana"><b>Name:</b> {entry.name}</span><br>
          <span class="legacy-font legacy-font--size--1 legacy-font--face-verdana">
            <b>Website:</b> {websiteUrl
              ? <a href={websiteUrl} rel="nofollow noopener noreferrer" target="_blank">{entry.website}</a>
              : (entry.website || " ")}
          </span><br>
          <span class="legacy-font legacy-font--size--1 legacy-font--face-verdana"><b>Referred by:</b> {entry.referred_by || " "}</span><br>
          <span class="legacy-font legacy-font--size--1 legacy-font--face-verdana"><b>From:</b> {entry.from_location || " "}</span><br>
          <span class="legacy-font legacy-font--size--1 legacy-font--face-verdana"><b>Time:</b> {new Date(entry.created_at).toISOString().replace("T", " ").slice(0, 19)}</span><br>
          <span class="legacy-font legacy-font--size--1 legacy-font--face-verdana"><b>Comments:</b> {entry.comments}</span>
        </td>
      </tr>
    );
  })}
</table>
</div>

<LegacyFooter />
</div>
</LegacyLayout>

<script src="https://www.google.com/recaptcha/api.js" async defer></script>



