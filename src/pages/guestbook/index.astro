---
import LegacyLayout from "../../layouts/LegacyLayout.astro";
import LegacyHeader from "../../components/LegacyHeader.astro";
import LegacyFooter from "../../components/LegacyFooter.astro";
import { getSupabaseClient } from "../../lib/supabase";

export const prerender = false;

const status = Astro.url.searchParams.get("status");
const siteKey = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY;

// Fetch approved entries from Supabase
const supabase = getSupabaseClient();
const { data: entries } = await supabase
  .from('guestbook_entries')
  .select('*')
  .eq('status', 'approved')
  .order('created_at', { ascending: false });

const sortedEntries = entries || [];
---
<LegacyLayout
  title="Guestbook @ mpls.com"
  description="Read and sign the MPLS.com guestbook to share your Minneapolis memories."
>
<div class="mpls-legacy">
<LegacyHeader showNav />



<div class="guestbook-header">
  <font face="Verdana,Helvetica,Arial" size="4"><b>Guestbook</b></font>
</div>

<div class="guestbook-status-container">
<table border="0" cellpadding="6" cellspacing="0" width="600">
<tr>
<td>
  {status === "ok" && (
    <p><font face="Verdana,Helvetica,Arial" size="-1" color="green"><b>✓ Success!</b> Your entry has been posted and is now visible in the guestbook.</font></p>
  )}
  {status === "pending" && (
    <p><font face="Verdana,Helvetica,Arial" size="-1" color="blue"><b>✓ Submitted!</b> Your entry has been received and will appear after review. Thank you for signing our guestbook!</font></p>
  )}
  {status === "banned" && (
    <p><font face="Verdana,Helvetica,Arial" size="-1" color="red"><b>✗ Entry Rejected</b> Your submission contains prohibited content or language. Please review our guidelines and try again with appropriate content.</font></p>
  )}
  {status === "captcha" && (
    <p><font face="Verdana,Helvetica,Arial" size="-1" color="orange"><b>⚠ Verification Failed</b> Please complete the reCAPTCHA verification and try again.</font></p>
  )}
  {status === "error" && (
    <p><font face="Verdana,Helvetica,Arial" size="-1" color="red"><b>✗ Error</b> There was a problem submitting your entry. Please check that all required fields are filled and within the length limits.</font></p>
  )}
</td>
</tr>
</table>
</div>

<div class="guestbook-form-container">
<table border="1" cellpadding="6" cellspacing="0" width="600">
<tr>
<td>
<a id="sign"></a>
<form action="/api/guestbook/submit" method="post">
  <input type="text" name="company" value="" tabindex="-1" autocomplete="off" aria-hidden="true" style="position:absolute;left:-9999px;">
  <table class="guestbook-form-table" border="0" cellpadding="4" cellspacing="0" width="100%">
    <tr>
      <td class="guestbook-form-label"><label for="gb-name"><font face="Verdana,Helvetica,Arial" size="-1">Name *</font></label></td>
      <td class="guestbook-form-field"><input type="text" id="gb-name" name="name" size="40" maxlength="120" required></td>
    </tr>
    <tr>
      <td class="guestbook-form-label"><label for="gb-website"><font face="Verdana,Helvetica,Arial" size="-1">Website</font></label></td>
      <td class="guestbook-form-field"><input type="text" id="gb-website" name="website" size="40" maxlength="120"></td>
    </tr>
    <tr>
      <td class="guestbook-form-label"><label for="gb-referred-by"><font face="Verdana,Helvetica,Arial" size="-1">Referred By</font></label></td>
      <td class="guestbook-form-field"><input type="text" id="gb-referred-by" name="referredBy" size="40" maxlength="120"></td>
    </tr>
    <tr>
      <td class="guestbook-form-label"><label for="gb-from"><font face="Verdana,Helvetica,Arial" size="-1">From</font></label></td>
      <td class="guestbook-form-field"><input type="text" id="gb-from" name="from" size="40" maxlength="120"></td>
    </tr>
    <tr>
      <td class="guestbook-form-label" valign="top"><label for="gb-comments"><font face="Verdana,Helvetica,Arial" size="-1">Comments *</font></label></td>
      <td class="guestbook-form-field"><textarea id="gb-comments" name="comments" rows="5" cols="46" maxlength="800" required></textarea></td>
    </tr>
    <tr>
      <td></td>
      <td class="guestbook-form-field">
        {siteKey ? (
          <div class="g-recaptcha" data-sitekey={siteKey} aria-label="reCAPTCHA"></div>
        ) : (
          <font face="Verdana,Helvetica,Arial" size="-2">reCAPTCHA site key missing.</font>
        )}
      </td>
    </tr>
    <tr>
      <td></td>
      <td class="guestbook-form-field"><input type="submit" value="Sign Guestbook"></td>
    </tr>
  </table>
</form>
</td>
</tr>
</table>
</div>

<div class="guestbook-entries-header">
<table border="0" cellpadding="6" cellspacing="0" width="600">
  <tr>
    <td>
      <font face="Verdana,Helvetica,Arial" size="-1"><b>Guestbook Entries</b></font>
    </td>
  </tr>
</table>
</div>

<div class="guestbook-entries-container">
<table border="1" cellpadding="6" cellspacing="0" width="600">
  {sortedEntries.map((entry) => {
    const websiteUrl = entry.website && entry.website.trim()
      ? (entry.website.startsWith('http://') || entry.website.startsWith('https://')
          ? entry.website
          : `http://${entry.website}`)
      : null;

    return (
      <tr>
        <td class="guestbook-entry-cell">
          <font face="Verdana,Helvetica,Arial" size="-1"><b>Record {entry.record}</b></font><br>
          <font face="Verdana,Helvetica,Arial" size="-1"><b>Name:</b> {entry.name}</font><br>
          <font face="Verdana,Helvetica,Arial" size="-1">
            <b>Website:</b> {websiteUrl
              ? <a href={websiteUrl} rel="nofollow noopener noreferrer" target="_blank">{entry.website}</a>
              : (entry.website || " ")}
          </font><br>
          <font face="Verdana,Helvetica,Arial" size="-1"><b>Referred by:</b> {entry.referred_by || " "}</font><br>
          <font face="Verdana,Helvetica,Arial" size="-1"><b>From:</b> {entry.from_location || " "}</font><br>
          <font face="Verdana,Helvetica,Arial" size="-1"><b>Time:</b> {new Date(entry.created_at).toISOString().replace("T", " ").slice(0, 19)}</font><br>
          <font face="Verdana,Helvetica,Arial" size="-1"><b>Comments:</b> {entry.comments}</font>
        </td>
      </tr>
    );
  })}
</table>
</div>

<LegacyFooter />
</div>
</LegacyLayout>

<script src="https://www.google.com/recaptcha/api.js" async defer></script>



